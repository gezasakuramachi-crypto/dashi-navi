<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>鹿嶋のご神幸 山車ナビ</title>
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --headerH: 48px;          /* タイトル帯の固定高さ（iPhone SEでも安全） */
      --footerH: 82px;          /* 下メニューバーの高さ */
      --pad: 10px;
      --z-header: 20;
      --z-ui: 30;
      --z-top: 40;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:#000; color:#111;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Hiragino Sans","Noto Sans JP",Meiryo,sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* ── ヘッダー（タイトル画像：左寄せ・指定の小さめ） ── */
    .app-header{
      position:fixed; left:0; right:0; top:0; height:var(--headerH);
      display:flex; align-items:center; gap:8px; padding:6px 10px;
      background:#000; z-index:var(--z-header);
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }
    .title-img{
      height:calc(var(--headerH) - 12px);
      width:auto; object-fit:contain; display:block;
    }

    /* ── 地図 ──
       100dvh: iOSのアドレスバー込み問題を回避
       env(safe-area-inset-bottom) を底に足す
    */
    #map{
      position:fixed; left:0; right:0; top:var(--headerH);
      height:calc(100dvh - var(--headerH) - var(--footerH) - env(safe-area-inset-bottom,0px));
      background:#eaeaea;    /* もし地図が出なくても真っ黒にならないように */
    }
    /* フォールバック：古いiOS用（100vhが小さくなる場合） */
    @supports not (height: 100dvh){
      #map{ height:calc(100vh - var(--headerH) - var(--footerH) - env(safe-area-inset-bottom,0px)); }
    }

    /* ── 左の縦アイコン（情報/トイレ/駐車場） ── */
    .left-stack{
      position:fixed; left:10px; top:calc(var(--headerH) + 10px); z-index:var(--z-ui);
    }
    .stack-card{ background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.18); padding:8px; display:grid; gap:8px; }
    .stack-btn{ width:48px; height:48px; border-radius:10px; display:grid; place-items:center; background:#fff; border:1px solid #e6e6e6; }
    .stack-btn img{ width:36px; height:36px; display:block; }

    /* ── 右上：交通規制ピル ── */
    .traffic-pill{
      position:fixed; right:12px; top:calc(var(--headerH) + 8px); z-index:var(--z-ui);
      background:#ff2d55; color:#fff; font-weight:700; border:0; cursor:pointer;
      padding:8px 10px; border-radius:9999px; box-shadow:0 6px 18px rgba(0,0,0,.18);
      font-size:14px; line-height:1; -webkit-user-select:none; user-select:none;
    }

    /* ── 左下：経路FAB（Googleマップへ） ── */
    .route-fab{
      position:fixed; left:14px; z-index:var(--z-ui);
      bottom:calc(var(--footerH) + 14px + env(safe-area-inset-bottom,0px));
      width:56px; height:56px; border-radius:16px; border:0; cursor:pointer;
      background:#0b8cff; color:#fff; font-size:22px;
      display:grid; place-items:center; box-shadow:0 10px 22px rgba(11,140,255,.35);
    }

    /* ── 下メニューバー（以前どおり：黒/アイコン＋文字） ── */
    .bottom-bar{
      position:fixed; left:0; right:0; bottom:0; z-index:var(--z-top);
      height:calc(var(--footerH) + env(safe-area-inset-bottom,0px));
      padding-bottom:env(safe-area-inset-bottom,0px);
      background:#000; color:#fff;
      display:grid; grid-template-columns:repeat(4,1fr); align-items:center;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .nav-btn{
      display:grid; grid-template-rows:auto auto; justify-items:center; align-content:center;
      row-gap:6px; padding:8px 0; background:none; border:0; color:#fff;
    }
    .nav-btn .icon{ width:38px; height:38px; border-radius:999px; display:grid; place-items:center; background:#111; border:1px solid #222; box-shadow:inset 0 0 0 1px rgba(255,255,255,.05); }
    .nav-btn .icon img{ width:28px; height:28px; display:block; }
    .nav-btn .label{ font-size:12px; letter-spacing:.02em; }

    /* ── InfoWindow を細身に ── */
    .gm-style .gm-style-iw-c{ max-width:240px !important; padding:8px 10px !important; border-radius:14px !important; }
    .gm-style .gm-style-iw-d{ overflow:auto !important; max-height:calc(100dvh - 220px) !important; }

    /* デバッグ用バナー（地図初期化失敗時） */
    #map-error{
      position:fixed; inset:auto 10px calc(var(--footerH) + 10px + env(safe-area-inset-bottom,0px)) 10px;
      z-index:9999; background:#ff3b30; color:#fff; padding:8px 12px; border-radius:10px;
      font-size:13px; box-shadow:0 6px 18px rgba(0,0,0,.25); display:none;
    }
  </style>
</head>
<body>

  <!-- ヘッダー（ご指定のタイトル画像・左寄せ） -->
  <header class="app-header">
    <img class="title-img" src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/title.png" alt="鹿嶋のご神幸" />
  </header>

  <!-- 地図 -->
  <div id="map" role="application" aria-label="山車ナビ地図"></div>
  <div id="map-error">地図の読み込みに失敗しました。APIキーやネットワークをご確認ください。</div>

  <!-- 左：情報/トイレ/駐車場 -->
  <div class="left-stack">
    <div class="stack-card">
      <button class="stack-btn" id="btn-info" title="インフォメーション表示/非表示">
        <img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/info.png" alt="info" />
      </button>
      <button class="stack-btn" id="btn-toilet" title="トイレ表示/非表示">
        <img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/toilet.png" alt="toilet" />
      </button>
      <button class="stack-btn" id="btn-parking" title="駐車場表示/非表示">
        <img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/parking.png" alt="parking" />
      </button>
    </div>
  </div>

  <!-- 右上：交通規制 -->
  <button class="traffic-pill" id="traffic-pill" type="button">交通<br>規制</button>

  <!-- 左下：経路（Googleマップへ） -->
  <button class="route-fab" id="route-fab" type="button" aria-label="山車までの経路">➤</button>

  <!-- 下ナビ（山車 / 交通規制 / 現在地 / ヘルプ）-->
  <nav class="bottom-bar">
    <button class="nav-btn" id="nav-dashi" type="button" aria-label="山車">
      <span class="icon"><img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/sakura.png" alt=""></span>
      <span class="label">山車</span>
    </button>
    <button class="nav-btn" id="nav-traffic" type="button" aria-label="交通規制">
      <span class="icon"><img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/no_entry.png" alt=""></span>
      <span class="label">交通規制</span>
    </button>
    <button class="nav-btn" id="nav-locate" type="button" aria-label="現在地">
      <span class="icon"><img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/locate.png" alt=""></span>
      <span class="label">現在地</span>
    </button>
    <button class="nav-btn" id="nav-help" type="button" aria-label="ヘルプ">
      <span class="icon"><img src="https://gezasakuramachi-crypto.github.io/dashi-navi/mark/help.png" alt=""></span>
      <span class="label">ヘルプ</span>
    </button>
  </nav>

  <!-- アプリ本体 -->
  <script src="./app.js"></script>

  <!-- Google Maps（キーを差し替え） -->
  <script>
    // 読み込み失敗時の検知
    window.gm_authFailure = function(){ document.getElementById('map-error').style.display='block'; };
    window.addEventListener('error', function(e){
      if (String(e?.filename||'').includes('maps.googleapis.com')){
        document.getElementById('map-error').style.display='block';
      }
    }, true);
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=marker&callback=initMap"></script>
</body>
</html>
